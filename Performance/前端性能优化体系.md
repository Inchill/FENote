# 前端性能优化体系

## 构成

1. 性能优化流程

主要包括性能指标设定、性能标准确定、收益评估、诊断清单、优化手段、性能立项、性能实践。

2. 性能指标采集与上报

它的主要内容是把前面提到的性能指标以代码的形式分解落地，确保可以采集，然后在 SDK 封装后集合统计埋点，最后根据实际情况，制定上报策略。

3. 性能监控预警平台

在构造上，性能监控预警平台包括：性能数据处理后台和性能可视化展现前台两部分。

## 如何设定性能指标

> FPS: Frames Per Second，每秒帧率。

1. 加载

2. 交互性

3. 视觉稳定性(CLS)

Cumulative Layout Shift，布局偏移量。

> 首屏时间 = 白屏时间 + 渲染时间。这期间不需要滚动鼠标或者下拉页面，否则无效。秒开率： 1s 内打开用户的占比。秒开率可用 Spark 计算得到。

首屏时间可以拆分为白屏时间、数据接口响应时间、图片加载资源等。

## 首屏指标自动化采集

需要考虑服务端模版业务，还是单页面应用。

### 服务端模版业务

HTML 文档加载解析完成的时间点，就是首屏时间点，而要采集这个首屏时间，可以用浏览器提供的 DOMContentLoaded 接口来实现。DOMContentLoaded，是指 DOM 树构建完成时触发的 API，之后会加载脚本文件、样式表然后解析并执行脚本文件，接着下载图片资源，这个过程是 load。

### SPA 业务

不能使用 Performance API 来采集，因为会和真实首屏时间存在很大差异。比如在 vue 中，页面先加载 `index.html`，加载完后会调用 DOMContentLoaded 和 load，但实际上此时只是一个空白页，之后才会加载各种脚本资源以及发起请求，这就会导致使用 Performance API 采集的首屏时间小于实际的首屏时间。

因此此时需要使用 MutationObserver 采集首屏时间。

## 白屏指标采集

白屏时间是指从输入内容回车（包括刷新、跳转等方式）后，到页面开始出现第一个字符的时间。

白屏时间的采集思路如下：白屏时间 = 页面开始展示时间点 - 开始请求时间点。如果你是借助浏览器的 Performance API 工具来采集，那么可以使用公式：白屏时间 FP = domLoading - navigationStart。

App下的白屏时间，多了启动浏览器内核，也就是 Webview 初始化的时间。这个时间必须通过手动采集的方式来获得。

## 卡顿指标采集

FPS，Frames Per Second，每秒显示帧数。通过采集 FPS 可以确定网络是否卡顿。

## 网络环境采集

一个做法是拿到两张不同尺寸图片的加载时间，通过计算结果来判定当前网络环境。

具体来说，我们在每次页面加载时，通过客户端向服务端发送图片请求，比如，请求一张 11 像素的图片和一张 33 像素的图片，然后在图片请求之初打一个时间点，在图片 onLoad 完成后打一个时间点，两个时间点之差，就是图片的加载时间。

接着，我们用文件体积除以加载时间，就能得出两张图片的加载速度，然后把两张图片的加载速度求平均值，这个结果就可以当作网络速度了。